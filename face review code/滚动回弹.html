<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="Keywords" content="" />
    <meta name="Description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta content="telephone=no" name="format-detection" />
    <meta content="email=no" name="format-detection" />
    <title>Document</title>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
      }

      div {
        position: relative;
        width: 200px;
        height: 300px;
        margin: 3em auto;
        border: 1px solid #ccc;
        overflow: hidden;
        -webkit-user-select: none;
        user-select: none;
      }

      ol {
        width: 100%;
      }

      ol > li {
        height: 30px;
      }
    </style>
  </head>

  <body>
    <div>
      <ol>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
      </ol>
    </div>
    <script>
      function myScroll(container) {
        let changeY = setPos()
        let height = container.clientHeight + 30
        let parentHeight = container.parentElement.clientHeight
        // 上下拉支持的多拉的距离
        let enableScrollHeight = 150
        // 需要重置边界滚动
        this.needUpInit = false
        this.needDownInit = false

        // 上一次鼠标的滚动Y
        this.preClientY = 0
        this.preTranslateY = 0
        this.tempY = 0

        container.addEventListener("touchstart", e => {
          this.preClientY = e.touches[0].clientY
        })

        container.addEventListener(
          "touchmove",
          e => {
            // 鼠标滚动的距离
            let scrollY = e.touches[0].clientY - this.preClientY

            changeY(scrollY)
          },
          false
        )

        container.addEventListener(
          "touchend",
          e => {
            this.preClientY = 0
            this.preTranslateY = this.tempY

            if (this.needUpInit) {
              this.needUpInit = false
              container.style =
                "transform:translateY(0px) translateZ(0);transition-duration: 600ms;"
            }

            if (this.needDownInit) {
              this.needDownInit = false

              container.style = `transform:translateY(${-(
                height - parentHeight
              )}px) translateZ(0);transition-duration: 600ms;`
            }

            setTimeout(() => {
              container.style.transitionDuration = "0ms"
            }, 800)
          },
          false
        )

        function setPos() {
          let preTime = 0
          let timeout = 0

          return function handle(y) {
            let now = new Date().getTime()

            // 加上50ms的节流
            timeout = setTimeout(() => {
              y = this.preTranslateY + y

              // 超出上拉阈值
              if (y > enableScrollHeight) {
                this.needUpInit = true
                return
              }

              // 超出下拉阈值
              if (-y + 300 >= height + enableScrollHeight) {
                this.needDownInit = true
                return
              }

              container.style.transform =
                "translateY(" + y + "px) translateZ(0)"
              this.tempY = y
              preTime = now
            }, 20)

            if (now - preTime <= 20) {
              clearTimeout(timeout)
            }
          }
        }
      }

      myScroll(document.querySelector("ol"))
    </script>
  </body>
</html>
